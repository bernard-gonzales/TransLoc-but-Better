<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Downed Vehicles - Headway Guard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{
    font-family:'FGDC';
    src:url('FGDC.ttf') format('truetype');
    font-weight:normal;
    font-style:normal;
  }
  :root{
    --bg:#24234B;
    --panel:#101935;
    --panel-soft:#142040;
    --ink:#f0f4ff;
    --muted:#9fb0c9;
    --line:rgba(159,176,201,0.25);
    --accent:#ffb347;
    --pill-down:#ff0000;
    --pill-hold:#FFFFFF;
    --pill-up:#00ff00;
    --pill-usable:#0000ff;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:16px/1.4 'FGDC',sans-serif;
    min-height:100vh;
    display:flex;
    justify-content:center;
  }
  main{
    width:100%;
    max-width:1600px;
    padding:24px 24px 32px;
    display:flex;
    flex-direction:column;
    gap:20px;
    min-height:100vh;
  }
  #sections{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:stretch;
  }
  section{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 18px 32px rgba(6,11,28,0.35);
    display:flex;
    flex-direction:column;
  }
  section header{
    padding:18px 24px 0;
  }
  section h2{
    margin:0;
    font-size:28px;
    text-transform:uppercase;
    letter-spacing:0.08em;
  }
  table{
    width:100%;
    border-collapse:collapse;
    table-layout:auto;
    background:var(--panel);
  }
  thead th{
    font-size:16px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.05em;
    padding:12px 12px 10px;
    border-bottom:1px solid var(--line);
    text-align:center;
  }
  tbody td{
    padding:14px 12px;
    border-top:1px solid rgba(159,176,201,0.08);
    vertical-align:middle;
    font-size:18px;
    line-height:1.3;
    text-align:center;
  }
  tbody tr:hover{
    background:var(--panel-soft);
  }
  tbody td.status{
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.08em;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 12px;
    border-radius:999px;
    font-size:14px;
    text-transform:uppercase;
    letter-spacing:0.05em;
    background:rgba(255,255,255,0.08);
  }
  .pill .dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:currentColor;
  }
  .pill.pulse-alert{position:relative;}
  .pill.pulse-alert .dot{
    position:relative;
    z-index:1;
  }
  .pill.pulse-alert .dot::after{
    content:'';
    position:absolute;
    inset:-6px;
    border-radius:50%;
    background:currentColor;
    opacity:0.45;
    transform:scale(0.6);
    z-index:-1;
    animation:statusPulse 1.8s ease-out infinite;
  }
  @keyframes statusPulse{
    0%{transform:scale(0.6); opacity:0.45;}
    70%{transform:scale(1.6); opacity:0;}
    100%{transform:scale(1.6); opacity:0;}
  }
  .pill.down,
  .pill.downed{color:var(--pill-down);}
  .pill.hold{color:var(--pill-hold);}
  .pill.up{color:var(--pill-up);}
  .pill.usable{color:var(--pill-usable);}
  .pill.cosmetic{color:#00ffff;}
  .pill.comfort{color:#ff00ff;}
  .pill.limited{color:#ffff00;}
  .pill.vsi{color:#ff6d01;}
  .pill.pm{color:#34a853;}
  .empty-indicator{
    padding:36px 24px;
    text-align:center;
    font-size:18px;
    color:var(--muted);
  }
  @media (max-width:1100px){
    table{font-size:14px;}
    tbody td{font-size:16px;}
    main{padding:20px 16px;}
    section h2{font-size:22px;}
  }
  @media (max-width:960px){
    #sections{gap:10px;}
  }
</style>
</head>
<body>
<main>
  <div id="sections"></div>
</main>
<script>
const ENDPOINT = '/v1/dispatcher/downed_buses';
const REFRESH_MS = 60000;
const sectionsContainer = document.getElementById('sections');
let refreshTimer = null;

const HIDDEN_HEADER_LABELS = new Set(['current eta']);

function abbreviateHeaderLabel(text){
  if(!text) return text;
  return String(text)
    .replace(/SUPERVISOR/gi,'SUP')
    .replace(/MECHANIC/gi,'MECH')
    .replace(/DIAGNOSTIC[\s\u00a0]*DATE/gi,'DIAG DATE')
    .replace(/ACTUAL DELIVERY DATE/gi,'DELIVERY DATE');
}

function normalizeHeader(text){
  return String(text || '')
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase();
}

function isHiddenHeader(text){
  return HIDDEN_HEADER_LABELS.has(normalizeHeader(text));
}

function isStatusHeader(text){
  return normalizeHeader(text) === 'status';
}

function findDiagnosticDateIndex(headers){
  if(!Array.isArray(headers)) return -1;
  for(let i=0;i<headers.length;i++){
    const normalized=normalizeHeader(headers[i]);
    if(!normalized) continue;
    if(normalized==='diagnostic date' || normalized==='diag date' || normalized.includes('diagnostic date')){
      return i;
    }
  }
  return -1;
}

function findDeliveryDateIndex(headers){
  if(!Array.isArray(headers)) return -1;
  for(let i=0;i<headers.length;i++){
    const normalized=normalizeHeader(headers[i]);
    if(!normalized) continue;
    if(normalized==='actual delivery date' || normalized==='delivery date' || normalized.includes('delivery date')){
      return i;
    }
  }
  return -1;
}

function parseCsv(text){
  const rows=[];
  let row=[];
  let cur='';
  let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQuotes){
      if(ch==='"'){
        if(text[i+1]==='"'){ cur+='"'; i++; }
        else{ inQuotes=false; }
      }else{
        cur+=ch;
      }
    }else{
      if(ch==='"') inQuotes=true;
      else if(ch===','){ row.push(cur); cur=''; }
      else if(ch==='\r'){ }
      else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else{ cur+=ch; }
    }
  }
  if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function cleanCell(value){
  if(value==null) return '';
  return String(value).replace(/\r\n?/g,'\n').trim();
}

function parseDeliveryDate(value){
  if(value==null) return null;
  const text=String(value).trim();
  if(!text) return null;
  const parsed=Date.parse(text);
  if(Number.isNaN(parsed)) return null;
  return new Date(parsed);
}

function getDeliveryCutoff(){
  const now=new Date();
  const startOfToday=new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const cutoff=new Date(startOfToday);
  cutoff.setDate(cutoff.getDate()-1);
  return cutoff;
}

function shouldHideByDeliveryDate(values, deliveryIndex, cutoff){
  if(deliveryIndex<0 || !Array.isArray(values) || deliveryIndex>=values.length) return false;
  const date=parseDeliveryDate(values[deliveryIndex]);
  if(!date) return false;
  return date<=cutoff;
}

function parseSheet(csvText){
  const rawRows = parseCsv(csvText||'');
  if(!rawRows.length) return { headerLine:[], sections:[] };
  const rows = rawRows.map(r => r.map(cleanCell));
  const headerLine = rows.shift() || [];
  const sections=[];
  let current=null;
  for(const row of rows){
    if(row.every(cell => !cell)) continue;
    const first=row[0];
    if(first==='Bus' || first==='P&T Support Vehicle'){
      current={ title:first, headers:row.slice(), rows:[] };
      sections.push(current);
      continue;
    }
    if(!current) continue;
    current.rows.push(row.slice());
  }
  return { headerLine, sections };
}

function getStatusClass(text){
  if(!text) return '';
  const upper=text.toUpperCase();
  const hasTerm=term=>new RegExp('\\b'+term+'\\b').test(upper);
  if(hasTerm('COSMETIC')) return 'cosmetic';
  if(hasTerm('COMFORT')) return 'comfort';
  if(hasTerm('DOWNED') || hasTerm('DOWN')) return 'downed';
  if(hasTerm('LIMITED')) return 'limited';
  if(hasTerm('VSI')) return 'vsi';
  if(hasTerm('PM')) return 'pm';
  if(hasTerm('HOLD')) return 'hold';
  if(hasTerm('USABLE')) return 'usable';
  if(hasTerm('UP')) return 'up';
  return '';
}

function renderSection(section){
  const wrapper=document.createElement('section');
  const title=section.title ? String(section.title).trim() : '';
  if(title && title!=='Bus' && title!=='P&T Support Vehicle'){
    const header=document.createElement('header');
    const heading=document.createElement('h2');
    heading.textContent=title;
    header.appendChild(heading);
    wrapper.appendChild(header);
  }

  if(!section.rows.length){
    const empty=document.createElement('div');
    empty.className='empty-indicator';
    empty.textContent='No records to display.';
    wrapper.appendChild(empty);
    return wrapper;
  }

  const table=document.createElement('table');
  const thead=document.createElement('thead');
  const headRow=document.createElement('tr');
  const visibleColumns=section.headers
    .map((text,index)=>({ text, index }))
    .filter(col=>!isHiddenHeader(col.text));

  visibleColumns.forEach(col => {
    const text=abbreviateHeaderLabel(col.text);
    const th=document.createElement('th');
    const normalized=normalizeHeader(text);
    if(text && normalized!=='bus' && normalized!=='p&t support vehicle'){
      const parts=String(text).split('\n');
      parts.forEach((part,idx)=>{
        if(idx>0) th.appendChild(document.createElement('br'));
        th.appendChild(document.createTextNode(part));
      });
    }else{
      th.textContent='';
    }
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody=document.createElement('tbody');
  const diagnosticIndex=findDiagnosticDateIndex(section.headers);
  const deliveryIndex=findDeliveryDateIndex(section.headers);
  const deliveryCutoff=getDeliveryCutoff();
  section.rows.forEach(row => {
    const tr=document.createElement('tr');
    const padded=row.slice();
    while(padded.length<section.headers.length){ padded.push(''); }
    if(shouldHideByDeliveryDate(padded, deliveryIndex, deliveryCutoff)) return;
    const diagnosticValue=(diagnosticIndex>=0 && diagnosticIndex<padded.length) ? padded[diagnosticIndex] : '';
    const hasDiagnosticDate=!!(diagnosticValue && String(diagnosticValue).trim());
    visibleColumns.forEach(col => {
      const { index, text: headerText } = col;
      const cell=padded[index];
      const td=document.createElement('td');
      const text=cell;
      if(isStatusHeader(headerText)){
        const cls=getStatusClass(text);
        td.className='status';
        if(text && cls){
          const pill=document.createElement('span');
          pill.classList.add('pill', cls);
          if(!hasDiagnosticDate){
            pill.classList.add('pulse-alert');
          }

          const dot=document.createElement('span');
          dot.className='dot';
          pill.appendChild(dot);

          const label=document.createElement('span');
          label.textContent=text;
          pill.appendChild(label);

          td.appendChild(pill);
        }else{
          td.textContent=text;
        }
      }else{
        td.textContent=text;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  if(!tbody.children.length){
    wrapper.removeChild(table);
    const empty=document.createElement('div');
    empty.className='empty-indicator';
    empty.textContent='No records to display.';
    wrapper.appendChild(empty);
    return wrapper;
  }
  table.appendChild(tbody);
  wrapper.appendChild(table);
  return wrapper;
}

function renderSheet(data){
  sectionsContainer.innerHTML='';
  if(!data.sections.length){
    const empty=document.createElement('div');
    empty.className='empty-indicator';
    empty.textContent='Unable to load downed vehicle data.';
    sectionsContainer.appendChild(empty);
    return;
  }
  data.sections.forEach(section => {
    sectionsContainer.appendChild(renderSection(section));
  });
}

async function loadSheet(){
  try{
    const res=await fetch(ENDPOINT,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const payload=await res.json();
    const csv=(payload && typeof payload.csv==='string') ? payload.csv : '';
    renderSheet(parseSheet(csv));
  }catch(err){
    console.error('Failed to load downed vehicles sheet', err);
    renderSheet({ headerLine:[], sections:[] });
  }
}

function start(){
  loadSheet();
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer=setInterval(loadSheet, REFRESH_MS);
}

document.addEventListener('visibilitychange',()=>{
  if(document.hidden) return;
  loadSheet();
});

start();
</script>
</body>
</html>
