<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="UTSShield.png" />
<meta charset="utf-8" />
<title>Two-Phase Commit Debug - UTS Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{ --bg:#0b0e11; --panel:#111821; --ink:#e8eef5; --line:#1f2630; --muted:#9fb0c9; --accent:#4ec0f1; }
  *{box-sizing:border-box;}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 'FGDC',sans-serif;}
  header{padding:16px 20px;border-bottom:1px solid var(--line);background:#0f141a;font-size:20px;letter-spacing:0.04em;}
  main{padding:20px;display:flex;flex-direction:column;gap:16px;}
  section.panel{background:var(--panel);border:1px solid var(--line);padding:16px;border-radius:8px;}
  h2{margin:0 0 12px 0;font-size:18px;letter-spacing:0.05em;color:var(--accent);}
  h3{margin:12px 0 8px 0;font-size:16px;}
  dl{display:grid;grid-template-columns:minmax(150px,220px) 1fr;gap:6px 12px;margin:0;}
  dl dt{color:var(--muted);font-weight:normal;}
  dl dd{margin:0;font-family:'FGDC',monospace;}
  ul,ol{margin:0;padding-left:18px;}
  .muted{color:var(--muted);}
  .error{color:#ff8484;}
  details{border:1px solid var(--line);border-radius:6px;padding:10px;background:#151d27;margin-bottom:10px;}
  details > summary{cursor:pointer;font-weight:bold;letter-spacing:0.03em;}
  details[open]{background:#192331;}
  .tx-meta{margin:10px 0;}
  .actions{margin:10px 0 0 0;padding-left:18px;}
  .actions li{margin-bottom:8px;}
  .preview{max-height:160px;overflow:auto;background:#0d1218;border:1px solid var(--line);padding:8px;border-radius:4px;font-family:monospace;white-space:pre-wrap;word-break:break-word;}
  footer{padding:12px 20px;color:var(--muted);font-size:12px;text-align:right;border-top:1px solid var(--line);}
</style>
</head>
<body>
<header>Two-Phase Commit Debug</header>
<main>
  <section class="panel" id="statusPanel">
    <h2>Overview</h2>
    <div id="overviewBody" class="muted">Loading two-phase commit state…</div>
    <div id="statusError" class="error"></div>
  </section>
  <section class="panel" id="transactionsPanel">
    <h2>Pending Transactions</h2>
    <div id="transactionsBody" class="muted">Fetching pending transaction data…</div>
  </section>
</main>
<footer>Auto-refreshes every 5 seconds.</footer>
<script>
const overviewBody=document.getElementById('overviewBody');
const transactionsBody=document.getElementById('transactionsBody');
const statusError=document.getElementById('statusError');

function renderOverview(data){
  const dl=document.createElement('dl');
  const fields=[
    ['Generated At',data.generated_at||''],
    ['Machine ID',data.machine?.machine_id||'unknown'],
    ['Region',data.machine?.region||'unknown'],
    ['Sync Secret Configured',data.sync_secret_configured?'yes':'no'],
    ['Two-PC Directory',data.two_pc_directory||''],
    ['Data Directories',(data.data_directories||[]).join(', ')||'—'],
    ['Sync Peers',(data.sync_peers||[]).length?data.sync_peers.join(', '):'None'],
    ['Required Machine IDs',(data.required_machine_ids||[]).length?data.required_machine_ids.join(', '):'None'],
    ['Commit Retry Limit',String(data.commit_retry_limit??'')],
    ['Commit Retry Delay (s)',String(data.commit_retry_delay??'')],
    ['Pending Transactions',String(data.pending_count??(data.pending_transactions?.length||0))]
  ];
  dl.innerHTML='';
  for(const [label,value] of fields){
    const dt=document.createElement('dt');
    dt.textContent=label;
    const dd=document.createElement('dd');
    dd.textContent=value;
    dl.appendChild(dt);
    dl.appendChild(dd);
  }
  overviewBody.innerHTML='';
  overviewBody.classList.remove('muted');
  overviewBody.appendChild(dl);
}

function renderTransactions(data){
  const transactions=data.pending_transactions||[];
  transactionsBody.innerHTML='';
  transactionsBody.classList.remove('muted');
  if(!transactions.length){
    transactionsBody.textContent='No pending transactions.';
    return;
  }
  const frag=document.createDocumentFragment();
  for(const tx of transactions){
    const details=document.createElement('details');
    details.open=true;
    const summary=document.createElement('summary');
    const age=(tx.age_seconds!=null)?`${tx.age_seconds.toFixed(1)}s old`:'';
    summary.textContent=`${tx.transaction_id||'unknown transaction'} • ${tx.action_count||0} actions${age?' • '+age:''}`;
    details.appendChild(summary);

    const meta=document.createElement('div');
    meta.className='tx-meta';
    const metaList=document.createElement('dl');
    const metaFields=[
      ['File',tx.filename||''],
      ['Size (bytes)',String(tx.size_bytes??'')],
      ['Updated At',tx.updated_at||''],
      ['Payload Keys',(tx.payload_keys||[]).join(', ')||'—']
    ];
    if(tx.error){
      metaFields.push(['Error',tx.error]);
    }
    for(const [label,value] of metaFields){
      const dt=document.createElement('dt');
      dt.textContent=label;
      const dd=document.createElement('dd');
      dd.textContent=value;
      metaList.appendChild(dt);
      metaList.appendChild(dd);
    }
    meta.appendChild(metaList);
    details.appendChild(meta);

    if(Array.isArray(tx.actions) && tx.actions.length){
      const actionsList=document.createElement('ol');
      actionsList.className='actions';
      tx.actions.forEach((action,index)=>{
        const li=document.createElement('li');
        const title=document.createElement('div');
        title.textContent=`${action.type||'unknown'}${action.name?` → ${action.name}`:''}`;
        li.appendChild(title);
        const rows=[];
        if(action.bytes!=null){rows.push(['Bytes',String(action.bytes)]);}
        if(action.sha256){rows.push(['SHA-256',action.sha256]);}
        if(action.preview){rows.push(['Preview',action.preview+(action.preview_truncated?' …':'')]);}
        if(rows.length){
          const actionDl=document.createElement('dl');
          rows.forEach(([label,value])=>{
            const dt=document.createElement('dt');
            dt.textContent=label;
            const dd=document.createElement('dd');
            if(label==='Preview'){
              const pre=document.createElement('pre');
              pre.className='preview';
              pre.textContent=value;
              dd.appendChild(pre);
            }else{
              dd.textContent=value;
            }
            actionDl.appendChild(dt);
            actionDl.appendChild(dd);
          });
          li.appendChild(actionDl);
        }
        actionsList.appendChild(li);
      });
      details.appendChild(actionsList);
    }

    frag.appendChild(details);
  }
  transactionsBody.appendChild(frag);
}

async function refresh(){
  try{
    statusError.textContent='';
    const res=await fetch('/v1/debug/2pc',{cache:'no-store'});
    if(!res.ok){
      throw new Error(`HTTP ${res.status}`);
    }
    const data=await res.json();
    renderOverview(data);
    renderTransactions(data);
  }catch(err){
    statusError.textContent=`Failed to load two-phase commit data: ${err.message||err}`;
  }
}

refresh();
setInterval(refresh,5000);
</script>
</body>
</html>
