<!doctype html>
<link rel="icon" type="image/png" href="headwayguardicon.png" />
<meta charset="utf-8">
<title>Headway Guard Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype')}
body{font:16px 'FGDC',system-ui;background:#0b0e11;color:#e8eef5;margin:0;padding:20px;}
label{display:block;margin:8px 0;}
input,textarea{width:100%;padding:6px;border-radius:4px;border:1px solid #2a3442;background:#10151c;color:#e8eef5;}
button{margin-top:12px;padding:10px 14px;border-radius:6px;border:1px solid #2a3442;background:#15202b;color:#e8eef5;cursor:pointer;}
.panel{margin-top:24px;padding:16px;border:1px solid #2a3442;border-radius:8px;background:#10151c;}
.panel h2{margin-top:0;margin-bottom:12px;font-size:18px;}
.secret{display:flex;flex-direction:column;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #202a36;}
.secret:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.secret code{word-break:break-all;background:#15202b;padding:6px;border-radius:6px;margin-top:6px;display:block;}
.credit{position:fixed;bottom:8px;right:8px;font-size:12px;color:var(--muted,#9fb0c9)}
#password-overlay{position:fixed;inset:0;background:rgba(7,10,14,.92);display:flex;align-items:center;justify-content:center;z-index:10000;opacity:1;transition:opacity .25s ease}
#password-overlay .overlay-card{background:#10151c;border:1px solid #2a3442;border-radius:18px;padding:28px;box-shadow:0 18px 32px rgba(6,11,28,.6);max-width:360px;width:90%;display:flex;flex-direction:column;gap:16px;text-align:center}
#password-overlay h2{margin:0;font-size:22px;letter-spacing:.08em;text-transform:uppercase;color:#cfe1ff}
#password-overlay p{margin:0;color:#9fb0c9;font-size:15px}
#password-overlay form{display:flex;flex-direction:column;gap:12px}
#password-overlay input{background:#0b1119;color:#e8eef5;border:1px solid #2a3442;border-radius:10px;padding:10px 12px;font-family:inherit;font-size:16px}
#password-overlay input:focus{outline:2px solid #3a83f5;outline-offset:2px}
#password-overlay button{align-self:center;min-width:140px}
#password-overlay .status{min-height:20px;font-size:14px;color:#ff8686}
#password-overlay.fade-out{opacity:0;pointer-events:none}
</style>
<div id="password-overlay">
  <div class="overlay-card">
    <h2>Admin Access</h2>
    <p>Enter the dispatch password to continue.</p>
    <form id="password-form">
      <input id="dispatch-password" type="password" autocomplete="current-password" placeholder="Password" required>
      <div class="status" id="password-status"></div>
      <button type="submit">Unlock</button>
    </form>
    <p style="font-size:13px;color:#cfe1ff">Need a password? Send Pat a Teams message.</p>
  </div>
</div>
<h1>Headway Guard Admin</h1>
<form id="cfg"></form>
<button id="save">Save</button>
<button id="forceRefresh">Force Refresh</button>
<div class="panel" id="secretPanel">
  <h2>Loaded Environment Secrets</h2>
  <div id="secrets"></div>
</div>
<div class="credit">proof of concept created by pat cox â€¢ phc6j@virginia.edu</div>
<script>
async function load(){
  const [cfg,secretPayload] = await Promise.all([
    fetch('/v1/config',{cache:'no-store'}).then(r=>r.json()),
    fetch('/v1/secrets',{cache:'no-store'}).then(r=>r.json()).catch(()=>({secrets:[]}))
  ]);
  const form=document.getElementById('cfg');
  for(const [k,v] of Object.entries(cfg)){
    const label=document.createElement('label');
    label.textContent=k;
    let inp;
    if(Array.isArray(v)){
      inp=document.createElement('textarea');
      inp.rows=2;
      inp.value=v.join(',');
    }else{
      inp=document.createElement('input');
      inp.value=v;
    }
    inp.name=k;
    label.appendChild(inp);
    form.appendChild(label);
  }
  const secretRoot=document.getElementById('secrets');
  secretRoot.innerHTML='';
  const secrets=Array.isArray(secretPayload?.secrets)?secretPayload.secrets:[];
  if(!secrets.length){
    const empty=document.createElement('div');
    empty.textContent='No Fly.io secrets detected.';
    secretRoot.appendChild(empty);
  }else{
    for(const item of secrets){
      const wrap=document.createElement('div');
      wrap.className='secret';
      const title=document.createElement('strong');
      title.textContent=item.name;
      const value=document.createElement('code');
      value.textContent=item.value;
      wrap.appendChild(title);
      wrap.appendChild(value);
      secretRoot.appendChild(wrap);
    }
  }
}
async function save(){
  const form=document.getElementById('cfg');
  const data={};
  for(const el of form.elements){
    if(!el.name) continue;
    if(el.tagName==='TEXTAREA'){
      data[el.name]=el.value.split(',').map(s=>s.trim()).filter(Boolean);
    }else{
      const num=parseFloat(el.value);
      data[el.name]=isNaN(num)?el.value:num;
    }
  }
  await fetch('/v1/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  alert('Saved!');
}
document.getElementById('save').onclick=save;
document.getElementById('forceRefresh').onclick=()=>{
  fetch('/v1/servicecrew/refresh',{method:'POST'});
};

const passwordOverlay=document.getElementById('password-overlay');
const passwordForm=document.getElementById('password-form');
const passwordInput=document.getElementById('dispatch-password');
const passwordStatus=document.getElementById('password-status');
const passwordButton=passwordForm?passwordForm.querySelector('button'):null;

function unlock(){
  if(passwordOverlay){
    passwordOverlay.classList.add('fade-out');
    setTimeout(()=>passwordOverlay.remove(),250);
  }
  load();
}

if(passwordForm&&passwordInput){
  const submitHandler=async evt=>{
    evt.preventDefault();
    if(!passwordInput.value.trim()){
      if(passwordStatus) passwordStatus.textContent='Please enter the password.';
      return;
    }
    if(passwordButton) passwordButton.disabled=true;
    try{
      const resp=await fetch('/api/dispatcher/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:passwordInput.value.trim()})});
      if(resp.ok){
        passwordForm.removeEventListener('submit',submitHandler);
        unlock();
        return;
      }
      let detail='Incorrect password.';
      try{
        const data=await resp.json();
        if(data?.detail) detail=data.detail;
      }catch(e){/* ignore */}
      if(passwordStatus) passwordStatus.textContent=detail;
    }catch(err){
      if(passwordStatus) passwordStatus.textContent='Unable to verify password. Try again.';
    }finally{
      if(passwordButton) passwordButton.disabled=false;
      passwordInput.value='';
      passwordInput.focus();
    }
  };
  passwordForm.addEventListener('submit',submitHandler);
  passwordInput.focus();
}
</script>
