<!doctype html>
<meta charset="utf-8">
<title>E-ink Block Display</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    color-scheme: only light;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    width:250px;
    height:122px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    color:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  }
  main{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:6px;
  }
  [hidden]{
    display:none !important;
  }
  #block-view{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
  }
  #bus{
    font-size:62px;
    font-weight:600;
    letter-spacing:1px;
    line-height:1;
  }
  #status{
    font-size:14px;
    letter-spacing:0.06em;
    text-transform:uppercase;
  }
  #grid-view{
    width:100%;
    height:100%;
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:4px;
    align-content:center;
    justify-items:center;
    font-weight:600;
    font-size:20px;
  }
  #grid-view .cell{
    width:100%;
    padding:6px 0;
    display:flex;
    align-items:center;
    justify-content:center;
    border:1px solid #000;
    border-radius:4px;
    min-height:20px;
  }
</style>
<main>
  <div id="block-view">
    <div id="bus">--</div>
    <div id="status"></div>
  </div>
  <div id="grid-view" hidden></div>
</main>
<script>
(function(){
  const params=new URLSearchParams(location.search);
  let block=params.get('block');
  const periodParam=(params.get('period')||'').trim().toLowerCase();
  const statusEl=document.getElementById('status');
  const busEl=document.getElementById('bus');
  const blockView=document.getElementById('block-view');
  const gridView=document.getElementById('grid-view');

  if(!block){
    document.title='Block Grid';
    blockView.hidden=true;
    gridView.hidden=false;
    const columns=[
      ['01','02','03','04','05','06','07','08','09'],
      ['10','11','12','13','14','15','16AM','17','18AM'],
      ['19','20AM','21AM','22AM','23AM','24AM','25AM','26AM','27'],
      ['', '20PM','21PM','22PM','23PM','24PM','25PM','26PM','27PM']
    ];
    gridView.innerHTML='';
    const rows=9;
    for(let row=0;row<rows;row++){
      for(let col=0;col<columns.length;col++){
        const cell=document.createElement('div');
        cell.className='cell';
        cell.textContent=columns[col][row]||'';
        gridView.appendChild(cell);
      }
    }
    return;
  }
  blockView.hidden=false;
  gridView.hidden=true;
  block=String(block).trim();
  let blockPeriod='';
  const blockMatch=block.match(/^(\d{2})(?:\s*(AM|PM))?$/i);
  if(blockMatch){
    block=blockMatch[1];
    if(blockMatch[2]) blockPeriod=blockMatch[2].toLowerCase();
  }
  if(!/^\d{2}$/.test(block)){
    statusEl.textContent='Invalid block';
    busEl.textContent='--';
    return;
  }

  const periodSuffix=blockPeriod||((periodParam==='am'||periodParam==='pm')?periodParam:'');
  const blockLabel = periodSuffix ? `${block} ${periodSuffix.toUpperCase()}` : block;
  document.title = `Block ${blockLabel}`;

  function parseTimeToMinutes(str){
    if(!str) return null;
    const value=String(str).trim();
    if(!value) return null;

    let match=value.match(/^PT(?:(\d+)H)?(?:(\d+)M)?$/i);
    if(match){
      const hours=parseInt(match[1]||'0',10);
      const minutes=parseInt(match[2]||'0',10);
      return hours*60+minutes;
    }

    match=value.match(/^\/Date\((\d+)\)\/$/);
    if(match){
      const date=new Date(Number(match[1]));
      if(!isNaN(date.getTime())){
        return date.getHours()*60+date.getMinutes();
      }
    }

    match=value.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if(match){
      let hours=parseInt(match[1],10)%12;
      const minutes=parseInt(match[2],10);
      if(match[3].toUpperCase()==='PM') hours+=12;
      return hours*60+minutes;
    }

    match=value.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if(match){
      const hours=parseInt(match[1],10);
      const minutes=parseInt(match[2],10);
      return hours*60+minutes;
    }

    return null;
  }

  function collectRanges(block){
    const ranges=[];
    const consider=(startStr,endStr)=>{
      const start=parseTimeToMinutes(startStr);
      const end=parseTimeToMinutes(endStr);
      if(start==null && end==null) return;
      ranges.push({start,end});
    };

    consider(block.BlockStartTime,block.BlockEndTime);
    consider(block.TripStartTime,block.TripEndTime);

    const trips=Array.isArray(block.Trips)?block.Trips:[];
    for(const trip of trips){
      consider(trip.BlockStartTime,trip.BlockEndTime);
      consider(trip.TripStartTime,trip.TripEndTime);
      consider(trip.StartTime,trip.EndTime);
      consider(trip.StartTimeDate,trip.EndTimeDate);
    }

    return ranges;
  }

  function buildEntry(group){
    const id=String(group.BlockGroupId||'').trim();
    const blocks=Array.isArray(group.Blocks)?group.Blocks:[];
    const blockNumbers=[];
    const seenNumbers=new Set();
    const matches=id.match(/\[(\d+)\]/g)||[];
    for(const raw of matches){
      const num=raw.replace(/[^0-9]/g,'');
      if(num && !seenNumbers.has(num)){
        seenNumbers.add(num);
        blockNumbers.push(num);
      }
    }

    const periodMatch=id.match(/\b(AM|PM)\b/i);
    const periodLabel=periodMatch?periodMatch[1].toLowerCase():'';

    let bus='—';
    for(const block of blocks){
      const trips=Array.isArray(block.Trips)?block.Trips:[];
      for(const trip of trips){
        if(trip && trip.VehicleName){
          bus=String(trip.VehicleName).trim();
          break;
        }
      }
      if(bus!=='—') break;
    }

    let minStart=null;
    let maxEnd=null;
    for(const block of blocks){
      const ranges=collectRanges(block);
      for(const range of ranges){
        let {start,end}=range;
        if(start==null && end==null) continue;
        if(start!=null){
          if(minStart==null || start<minStart) minStart=start;
        }
        if(start!=null && end!=null && end<start){
          end+=1440;
        }
        if(end!=null){
          if(minStart!=null && end<minStart){
            while(end<minStart){
              end+=1440;
            }
          }
          if(maxEnd==null || end>maxEnd) maxEnd=end;
        }
      }
    }

    return {id,blockNumbers,period:periodLabel,bus,minStart,maxEnd};
  }

  function isActive(entry,nowMinutes){
    if(entry.minStart==null || entry.maxEnd==null) return false;
    let start=entry.minStart;
    let end=entry.maxEnd;
    let now=nowMinutes;
    if(end<start){
      end+=1440;
      if(now<start) now+=1440;
    }
    return now>=start && now<=end;
  }

  function pickBest(entries,nowMinutes){
    if(!entries.length) return null;
    const active=entries.filter(e=>isActive(e,nowMinutes));
    const activeWithBus=active.find(e=>e.bus && e.bus!=='—');
    if(activeWithBus) return activeWithBus;
    if(active.length) return active[0];

    const withBus=entries.find(e=>e.bus && e.bus!=='—');
    if(withBus) return withBus;

    return entries[0];
  }

  async function refresh(){
    try{
      statusEl.textContent='';
      const res=await fetch('/v1/dispatch/blocks');
      if(!res.ok) throw new Error(res.status+'');
      const data=await res.json();
      const groups=Array.isArray(data.block_groups)?data.block_groups:[];
      const entries=[];
      for(const group of groups){
        const entry=buildEntry(group);
        if(entry.blockNumbers.length){
          entries.push(entry);
        }
      }

      const now=new Date();
      const nowMinutes=now.getHours()*60+now.getMinutes();

      const matches=entries.filter(e=>e.blockNumbers.includes(block));
      let filtered=matches;
      if(periodSuffix){
        const exact=matches.filter(e=>e.period===periodSuffix);
        if(exact.length) filtered=exact;
      }

      const best=pickBest(filtered,nowMinutes) || pickBest(matches,nowMinutes);
      const bus=(best && best.bus)?best.bus:'—';
      busEl.textContent=bus||'—';
      statusEl.textContent='';
    }catch(err){
      console.error(err);
      statusEl.textContent='Offline';
      busEl.textContent='--';
    }
  }

  refresh();
  setInterval(refresh, 30000);
})();
</script>
