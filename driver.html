<!doctype html>
<html>
<meta charset="utf-8" />
<title>Driver Anti-Bunching</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/polyline@1.1.1"></script>
<style>
  :root{ --bg:#0b0e11; --panel:#0f141a; --ink:#e8eef5; --muted:#9fb0c9; --line:#1f2630; --chip:#2a3442; --ok:#24c28a; --warn:#ffbf47; --bad:#ff6b6b; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial;}
  body.centered{display:flex;align-items:center;justify-content:center;}
  .card{width:min(560px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 12px 0;font-size:18px}
  label{display:block;margin:8px 0 6px 2px;color:var(--muted)}
  select{width:100%;background:#10151c;color:var(--ink);border:1px solid var(--chip);border-radius:10px;padding:10px}
  .row{display:flex;gap:10px}
  .row>div{flex:1}
  .btn{width:100%;margin-top:12px;background:#15202b;border:1px solid var(--chip);color:var(--ink);border-radius:10px;padding:10px;cursor:pointer;font-weight:600}
  .btn:hover{filter:brightness(1.1)}
  .btn.danger{background:#2b1515;border-color:#523737}
  .btn.danger:hover{filter:brightness(1.05)}
  .out{margin-top:14px;border-top:1px solid var(--line);padding-top:12px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid var(--chip);background:#10151c}
  .dot{width:10px;height:10px;border-radius:999px;background:#718096;box-shadow:0 0 0 1px rgba(0,0,0,.35) inset}
  .green .dot{background:var(--ok)} .yellow .dot{background:var(--warn)} .red .dot{background:var(--bad)}
  .green{color:#b9f4db} .yellow{color:#ffe29a} .red{color:#ffb0b0}
  .big{font-size:22px}
  .muted{color:var(--muted)}
  /* Dashboard layout */
  #dashboard{display:flex;height:100%;width:100%;}
  #left,#right{flex:1;display:flex;flex-direction:column;}
  #topbar{background:var(--panel);padding:8px 12px;border-bottom:1px solid var(--line);}
  #info{padding:12px;flex:1;display:flex;flex-direction:column;}
  #info .out{margin-top:0;border-top:none;padding-top:0;}
  #clock{flex:0 0 33%;display:flex;align-items:center;justify-content:center;font-size:48px;border-bottom:1px solid var(--line);background:var(--panel);}
  #map{flex:1;}
</style>
<body class="centered">
<div id="setup" class="card">
  <h1>Driver Anti-Bunching</h1>
  <div id="warn" class="muted" style="display:none;margin:6px 2px 2px"></div>
  <div id="setupInner">
    <div class="row">
      <div>
        <label>Unit Number</label>
        <select id="bus"></select>
      </div>
      <div>
        <label>Route</label>
        <select id="route"></select>
      </div>
    </div>
    <button id="go" class="btn">Start Anti-Bunching</button>
    <div class="muted" style="margin-top:8px">Pick your bus and route, then press Start.</div>
  </div>
</div>
<div id="dashboard" style="display:none">
  <div id="left">
    <div id="topbar"></div>
    <div id="info">
      <div id="out" class="out"><div class="muted">Connecting…</div></div>
      <button id="end" class="btn danger" style="margin-top:auto">End Anti-Bunching</button>
    </div>
  </div>
  <div id="right">
    <div id="clock"></div>
    <div id="map"></div>
  </div>
</div>
<script>
const $ = s=>document.querySelector(s);
const fmt = s=>{ if(s==null||!isFinite(s)) return "—"; s=Math.round(s); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; };
const pill = st=>{ const m={green:["OK","green"],yellow:["Ease off","yellow"],red:["HOLD","red"]}; const [t,c]=m[st]||["OK","green"]; return `<span class="pill ${c} big"><span class="dot"></span><span>${t}</span></span>`; };
async function j(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.json(); }
let timer=null, busTimer=null, currentBus="", currentRoute=0, map=null, routeLayer=null, markers={};
// Load pickers once
async function loadBuses(){
  let list=[];
  try{ const d=await j('/v1/vehicles?include_stale=1&include_unassigned=1'); list=(d.vehicles||[]).map(x=>x.name); }
  catch(e){ try{ const d=await j('/v1/roster/vehicles'); list=(d.vehicles||[]).map(x=>x.name); } catch(_) { list=[]; } }
  const uniq=[...new Set(list.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b)));
  $('#bus').innerHTML=uniq.map(n=>`<option>${n}</option>`).join('');
}
async function loadRoutes(){
  let list=[]; const d=await j('/v1/routes_all'); list=(d.routes||[]);
  list.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
  $('#route').innerHTML=list.map(r=>`<option value="${r.id}">${r.name}${r.active?'':' (inactive)'}</option>`).join('');
}
function showSession(busName, routeId, routeLabel){
  $('#setup').style.display='none';
  document.body.classList.remove('centered');
  $('#dashboard').style.display='flex';
  $('#topbar').textContent = `Unit ${busName} • Route: ${routeLabel}`;
  updateClock();
  if(timer) clearInterval(timer);
  tick();
  timer = setInterval(tick, 5000);
  initMap();
  if(busTimer) clearInterval(busTimer);
  updateBuses();
  busTimer = setInterval(updateBuses, 4000);
}
function showSetup(){
  $('#dashboard').style.display='none';
  document.body.classList.add('centered');
  $('#setup').style.display='block';
  if(map){ map.remove(); map=null; routeLayer=null; markers={}; }
  if(timer) { clearInterval(timer); timer=null; }
  if(busTimer){ clearInterval(busTimer); busTimer=null; }
}
async function tick(){
  try{
    const data=await j(`/v1/routes/${currentRoute}/vehicles/${encodeURIComponent(currentBus)}/instruction`);
    const cls=(data.order==='HOLD'?'red':(data.order==='Ease off'?'yellow':'green'));
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    $('#out').innerHTML = `${pill(cls)}<div class=\"mono\" style=\"margin-top:10px\">Headway: ${data.headway||'—'} • Target: ${data.target||'—'}<br>Gap: ${data.gap||'—'} • Countdown: ${data.countdown||'—'}<br><span class=\"muted\">Leader: ${data.leader||'—'} • Updated: ${new Date((data.updated_at||Date.now()/1000)*1000).toLocaleTimeString([], {timeZone: tz})}</span></div>`;
  } catch(e){
    $('#out').innerHTML = `<div class=\"red mono\">Waiting for route to become active...</div><div class=\"muted\">Page will update when route becomes active. Ensure selected route and unit are correct.</div>`;
  }
}
function updateClock(){
  const now=new Date();
  const t=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  $('#clock').textContent=t;
}
setInterval(updateClock,1000);
function initMap(){
  map = L.map('map').setView([38.03799212281404, -78.50981502838886], 14);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'}).addTo(map);
  loadRoutePath();
}
async function loadRoutePath(){
  try{
    const res=await fetch('https://uva.transloc.com/Services/JSONPRelay.svc/GetRoutesForMapWithScheduleWithEncodedLine?APIKey=8882812681');
    const data=await res.json();
    const r=data.find(x=>x.RouteID==currentRoute);
    if(r && r.EncodedPolyline){
      const pts=polyline.decode(r.EncodedPolyline);
      routeLayer=L.polyline(pts,{color:'#E57200',weight:5}).addTo(map);
      map.fitBounds(routeLayer.getBounds());
    }
  }catch(e){console.error('route load',e);}
}
async function updateBuses(){
  if(!map) return;
  try{
    const res=await fetch('https://uva.transloc.com/Services/JSONPRelay.svc/GetMapVehiclePoints?APIKey=8882812681');
    const data=await res.json();
    const active=new Set();
    data.forEach(v=>{
      if(v.RouteID==currentRoute){
        const id=v.VehicleID;
        const pos=[v.Latitude,v.Longitude];
        active.add(id);
        if(markers[id]){ markers[id].setLatLng(pos); }
        else { markers[id]=L.marker(pos).bindTooltip(v.Name,{permanent:true,direction:'top'}).addTo(map); }
      }
    });
    Object.keys(markers).forEach(id=>{ if(!active.has(Number(id))){ map.removeLayer(markers[id]); delete markers[id]; }});
  }catch(e){console.error('bus load',e);}
}
$('#go').onclick = ()=>{
  currentBus = $('#bus').value;
  currentRoute = Number($('#route').value);
  const routeLabel = $('#route').selectedOptions[0]?.text || `Route ${currentRoute}`;
  showSession(currentBus, currentRoute, routeLabel);
};
$('#end').onclick = ()=>{
  currentBus=""; currentRoute=0;
  $('#out').innerHTML='<div class=\"muted\">Pick your bus and route, then press Start.</div>';
  showSetup();
};
document.addEventListener('DOMContentLoaded', async ()=>{ try{ await loadBuses(); await loadRoutes(); }catch(e){ $('#out').textContent='Error loading lists'; } });
async function pollHealth(){
  try{ const h=await j('/v1/health'); const w=$('#warn'); if(!h.ok && h.last_error){ w.style.display='block'; w.textContent='Feed error: '+h.last_error; } else { w.style.display='none'; w.textContent=''; } }
  catch(e){ const w=$('#warn'); w.style.display='block'; w.textContent='Health check failed'; }
  setTimeout(pollHealth,15000);
}
pollHealth();
</script>
</body>
</html>
