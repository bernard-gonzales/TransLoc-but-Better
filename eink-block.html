<!doctype html>
<meta charset="utf-8">
<title>E-ink Block Display</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    color-scheme: only light;
  }
  *{box-sizing:border-box;}
  @font-face{
    font-family:'FGDC';
    src:url('FGDC.ttf') format('truetype');
    font-display:swap;
  }
  @font-face{
    font-family:'CenturyGothic';
    src:url('centurygothic.ttf') format('truetype');
    font-display:swap;
  }
  body{
    margin:0;
    width:250px;
    height:122px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    color:#000;
    font-family:'FGDC',sans-serif;
  }
  body.grid-mode{
    width:auto;
    min-width:280px;
    height:auto;
    padding:12px;
  }
  main{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:6px;
  }
  body.grid-mode main{
    height:auto;
    justify-content:flex-start;
    padding:0;
  }
  [hidden]{
    display:none !important;
  }
  #block-view{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
  }
  #block-number{
    font-family:'CenturyGothic',sans-serif;
    font-size:22px;
    letter-spacing:0.08em;
    text-transform:uppercase;
  }
  #bus{
    font-size:62px;
    font-weight:600;
    letter-spacing:1px;
    line-height:1;
  }
  #status{
    font-size:14px;
    letter-spacing:0.06em;
    text-transform:uppercase;
  }
  #grid-view{
    width:520px;
    max-width:100%;
    border:3px solid #000;
    display:flex;
    flex-direction:column;
    font-weight:600;
    font-size:18px;
    background:#fff;
    margin:0 auto;
  }
  body.grid-mode #grid-view{
    height:auto;
  }
  #grid-view .grid-controls{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    flex-wrap:wrap;
    padding:8px 12px;
    border-bottom:3px solid #000;
    font-family:'CenturyGothic',sans-serif;
    font-size:14px;
    letter-spacing:0.04em;
    text-transform:uppercase;
  }
  #grid-view .grid-controls .grid-controls-status{
    flex:1;
  }
  #grid-view .grid-controls .grid-controls-buttons{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  #grid-view .grid-controls button{
    font-family:'CenturyGothic',sans-serif;
    font-size:12px;
    letter-spacing:0.04em;
    text-transform:uppercase;
    padding:6px 10px;
    border:2px solid #000;
    background:#fff;
    cursor:pointer;
  }
  #grid-view .grid-controls button:active{
    background:#000;
    color:#fff;
  }
  #grid-view .grid-header{
    font-family:'CenturyGothic',sans-serif;
    font-size:22px;
    letter-spacing:0.1em;
    text-transform:uppercase;
    text-align:center;
    padding:12px 8px;
    border-bottom:3px solid #000;
  }
  #grid-view .grid-table{
    --grid-columns:4;
    display:grid;
    grid-template-columns:repeat(var(--grid-columns),1fr);
    grid-template-rows:repeat(9,minmax(48px,1fr));
    width:100%;
  }
  #grid-view .cell{
    padding:10px 6px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:40px;
    gap:6px;
  }
  #grid-view .cell.editable{
    cursor:pointer;
    position:relative;
  }
  #grid-view .cell.editable::after{
    content:'Edit';
    position:absolute;
    bottom:6px;
    right:6px;
    font-size:10px;
    letter-spacing:0.08em;
    color:#555;
  }
  #grid-view .cell{
    border-top:2px solid #000;
    border-left:2px solid #000;
  }
  #grid-view .cell[data-row="0"]{
    border-top:none;
  }
  #grid-view .cell[data-col="0"]{
    border-left:none;
  }
  #grid-view .cell .block-label{
    font-family:'CenturyGothic',sans-serif;
    font-size:14px;
    letter-spacing:0.06em;
  }
  #grid-view .cell .bus{
    font-size:18px;
  }
</style>
<main>
  <div id="block-view">
    <div id="block-number" hidden>Block --</div>
    <div id="bus">--</div>
    <div id="status"></div>
  </div>
  <div id="grid-view" hidden>
    <div class="grid-header">BLOCK ASSIGNMENTS</div>
    <div class="grid-table"></div>
  </div>
</main>
<script>
(function(){
  const params=new URLSearchParams(location.search);
  const enableColors=params.get('colors')==='true';
  const editMode=params.get('edit')==='true';
  let block=params.get('block');
  const periodParam=(params.get('period')||'').trim().toLowerCase();
  const statusEl=document.getElementById('status');
  const busEl=document.getElementById('bus');
  const blockView=document.getElementById('block-view');
  const gridView=document.getElementById('grid-view');
  const blockNumberEl=document.getElementById('block-number');
  const isGridMode=!block;
  let blockPeriod='';
  let selectedBlockNumber='';
  let selectedBlockId='';

  const ROW_COUNT=9;

  const normalizeIdentifier=value=>String(value||'').replace(/[^0-9a-z]/gi,'').toUpperCase();
  const cleanBusIdentifier=value=>{
    if(value==null) return '';
    const text=String(value).trim();
    if(!text) return '';
    if(text==='—') return '';
    if(/^0+$/.test(text)) return '';
    return text;
  };

  const defaultColumns=[
    ['01','02','03','04','05','06','07','08','09'],
    ['10','11','12','13','14','15','16AM','17','18AM'],
    ['19','20AM','21AM','22AM','23AM','24AM','25AM','26AM','27'],
    ['','20PM','21PM','22PM','23PM','24PM','25PM','26PM','27PM']
  ];

  const createBlankColumn=()=>Array.from({length:ROW_COUNT},()=>'' );

  const normalizeColumn=(column,fallback)=>{
    const result=createBlankColumn();
    const source=Array.isArray(column)?column:[];
    const fallbackSource=Array.isArray(fallback)?fallback:[];
    for(let i=0;i<ROW_COUNT;i++){
      const value=source[i];
      if(typeof value==='string'){
        result[i]=value;
      }else if(value!=null){
        result[i]=String(value);
      }else{
        const fallbackValue=fallbackSource[i];
        if(typeof fallbackValue==='string'){
          result[i]=fallbackValue;
        }else if(fallbackValue!=null){
          result[i]=String(fallbackValue);
        }
      }
    }
    return result;
  };

  function loadLayout(){
    try{
      const stored=localStorage.getItem('einkBlockLayout');
      if(stored){
        const parsed=JSON.parse(stored);
        if(Array.isArray(parsed) && parsed.length){
          const result=[];
          for(let colIndex=0;colIndex<parsed.length;colIndex++){
            result.push(normalizeColumn(parsed[colIndex]));
          }
          if(result.length){
            return result;
          }
        }
      }
    }catch(err){
      console.warn('Failed to load custom layout',err);
    }
    return defaultColumns.map(col=>normalizeColumn(col));
  }

  let layout=loadLayout();

  function saveLayout(){
    try{
      localStorage.setItem('einkBlockLayout',JSON.stringify(layout));
    }catch(err){
      console.warn('Failed to save layout',err);
    }
  }

  function resetLayout(){
    layout=defaultColumns.map(col=>normalizeColumn(col));
    saveLayout();
    buildGrid();
  }

  function getCellColors(block,period){
    const blockId=(block||'').padStart(2,'0');
    const periodId=(period||'').toLowerCase();
    if(!blockId) return null;

    const numeric=parseInt(blockId,10);

    if(['01','02'].includes(blockId)) return {bg:'#0C8103',text:'#fff'};
    if(['03','04'].includes(blockId)) return {bg:'#232D48',text:'#fff'};
    if(numeric>=5 && numeric<=8) return {bg:'#FF7300',text:'#111'};
    if(numeric>=9 && numeric<=12) return {bg:'#FFDD00',text:'#000'};
    if(numeric>=13 && numeric<=14) return {bg:'#C3C1C1',text:'#000'};
    if(numeric>=15 && numeric<=18) return {bg:'#0072BC',text:'#fff'};

    if(periodId==='am' && numeric>=20 && numeric<=26){
      return {bg:'#F60303',text:'#fff'};
    }

    if(periodId==='pm' && ['20','21','22','24','26'].includes(blockId)){
      return {bg:'#F60303',text:'#fff'};
    }

    return null;
  }

  function applyCellColors(cell){
    if(!enableColors || !cell || !cell.dataset) return;
    const colors=getCellColors(cell.dataset.block,cell.dataset.period||'');
    if(colors){
      cell.style.backgroundColor=colors.bg;
      cell.style.color=colors.text;
    }
  }

  function buildGrid(){
    const gridTable=gridView.querySelector('.grid-table');
    if(!gridTable) return;
    if(!Array.isArray(layout) || !layout.length){
      layout=[createBlankColumn()];
    }
    layout=layout.map(col=>normalizeColumn(col));
    gridTable.innerHTML='';
    const rows=ROW_COUNT;
    const columnCount=Math.max(layout.length,1);
    gridTable.style.setProperty('--grid-columns',String(columnCount));
    gridTable.style.gridTemplateColumns=`repeat(${columnCount},1fr)`;
    for(let row=0;row<rows;row++){
      for(let col=0;col<layout.length;col++){
        const column=layout[col]||[];
        const label=column[row]||'';
        const trimmedLabel=label.trim();
        const normalizedLabel=normalizeIdentifier(trimmedLabel);
        const cell=document.createElement('div');
        cell.className='cell';
        cell.dataset.col=String(col);
        cell.dataset.row=String(row);
        if(editMode){
          cell.classList.add('editable');
        }
        if(trimmedLabel){
          const match=normalizedLabel.match(/^(\d{2})(AM|PM)?$/);
          const embeddedMatch=match||normalizedLabel.match(/(\d{2})(AM|PM)?$/);
          if(match){
            cell.dataset.block=match[1];
            cell.dataset.period=(match[2]||'').toLowerCase();
          }else if(embeddedMatch){
            cell.dataset.block=embeddedMatch[1];
            cell.dataset.period=(embeddedMatch[2]||'').toLowerCase();
          }
          cell.dataset.customBlockId=normalizedLabel;
          const blockNumber=match?match[1]:trimmedLabel;
          const periodSuffix=match && match[2]?match[2].toUpperCase():'';
          const displayLabel=match? (periodSuffix?`Block ${blockNumber} ${periodSuffix}`:`Block ${blockNumber}`) : trimmedLabel;
          cell.innerHTML=`<div class="block-label">${displayLabel}</div><div class="bus">—</div>`;
          applyCellColors(cell);
        }else if(editMode){
          cell.innerHTML='<div class="block-label">Empty</div><div class="bus">—</div>';
        }
        gridTable.appendChild(cell);
      }
    }
  }

  if(isGridMode){
    document.body.classList.add('grid-mode');
    document.title='Block Grid';
    blockView.hidden=true;
    gridView.hidden=false;
    if(blockNumberEl) blockNumberEl.hidden=true;
    const controls=gridView.querySelector('.grid-controls');
    if(editMode){
      if(!controls){
        const controlsEl=document.createElement('div');
        controlsEl.className='grid-controls';
        controlsEl.innerHTML='<span class="grid-controls-status">Edit Mode — click a block to change it</span><div class="grid-controls-buttons"><button type="button" id="add-column">Add Column</button><button type="button" id="remove-column">Remove Column</button><button type="button" id="reset-layout">Reset Layout</button></div>';
        gridView.insertBefore(controlsEl,gridView.firstChild);
      }
    }else if(controls){
      controls.remove();
    }
    buildGrid();
  }
  if(!isGridMode){
    document.body.classList.remove('grid-mode');
    blockView.hidden=false;
    gridView.hidden=true;
    if(blockNumberEl) blockNumberEl.hidden=false;
    block=String(block).trim();
    const normalizedBlock=normalizeIdentifier(block);
    const blockMatch=normalizedBlock.match(/^(\d{2})(AM|PM)?$/);
    if(blockMatch){
      block=blockMatch[1];
      if(blockMatch[2]) blockPeriod=blockMatch[2].toLowerCase();
      const periodSuffix=blockPeriod||((periodParam==='am'||periodParam==='pm')?periodParam:'');
      selectedBlockNumber=blockMatch[1];
      selectedBlockId=normalizedBlock;
      const blockLabel = periodSuffix ? `${block} ${periodSuffix.toUpperCase()}` : block;
      document.title = `Block ${blockLabel}`;
      if(blockNumberEl){
        blockNumberEl.textContent = `Block ${blockLabel}`;
      }
    }else{
      if(normalizedBlock && /^\d+$/.test(normalizedBlock)){
        statusEl.textContent='Invalid block';
        busEl.textContent='--';
        if(blockNumberEl){
          blockNumberEl.textContent='Block --';
        }
        return;
      }
      selectedBlockNumber='';
      selectedBlockId=normalizedBlock||'';
      document.title=block||'Block';
      if(blockNumberEl){
        blockNumberEl.textContent=block||'';
      }
    }
  }

  function parseTimeToMinutes(str){
    if(!str) return null;
    const value=String(str).trim();
    if(!value) return null;

    let match=value.match(/^PT(?:(\d+)H)?(?:(\d+)M)?$/i);
    if(match){
      const hours=parseInt(match[1]||'0',10);
      const minutes=parseInt(match[2]||'0',10);
      return hours*60+minutes;
    }

    match=value.match(/^\/Date\((\d+)\)\/$/);
    if(match){
      const date=new Date(Number(match[1]));
      if(!isNaN(date.getTime())){
        return date.getHours()*60+date.getMinutes();
      }
    }

    match=value.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if(match){
      let hours=parseInt(match[1],10)%12;
      const minutes=parseInt(match[2],10);
      if(match[3].toUpperCase()==='PM') hours+=12;
      return hours*60+minutes;
    }

    match=value.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if(match){
      const hours=parseInt(match[1],10);
      const minutes=parseInt(match[2],10);
      return hours*60+minutes;
    }

    return null;
  }

  const MINUTES_PER_DAY=1440;
  const NOON_MINUTES=12*60;

  function collectRanges(block){
    const ranges=[];
    const consider=(startStr,endStr)=>{
      const start=parseTimeToMinutes(startStr);
      const end=parseTimeToMinutes(endStr);
      if(start==null && end==null) return;
      ranges.push({start,end});
    };

    consider(block.BlockStartTime,block.BlockEndTime);
    consider(block.TripStartTime,block.TripEndTime);

    const trips=Array.isArray(block.Trips)?block.Trips:[];
    for(const trip of trips){
      consider(trip.BlockStartTime,trip.BlockEndTime);
      consider(trip.TripStartTime,trip.TripEndTime);
      consider(trip.StartTime,trip.EndTime);
      consider(trip.StartTimeDate,trip.EndTimeDate);
    }

    return ranges;
  }

  function calculatePeriodMinutes(start,end){
    let am=0;
    let pm=0;
    if(start==null || end==null) return {am,pm};

    let rangeStart=start;
    let rangeEnd=end;
    if(rangeEnd<rangeStart) rangeEnd+=MINUTES_PER_DAY;

    while(rangeStart<rangeEnd){
      const dayStart=Math.floor(rangeStart/MINUTES_PER_DAY)*MINUTES_PER_DAY;
      const dayEnd=dayStart+MINUTES_PER_DAY;
      const segmentEnd=Math.min(rangeEnd,dayEnd);
      const segStartOfDay=rangeStart-dayStart;
      const segEndOfDay=segmentEnd-dayStart;

      const amStart=Math.max(segStartOfDay,0);
      const amEnd=Math.min(segEndOfDay,NOON_MINUTES);
      if(amEnd>amStart) am+=amEnd-amStart;

      const pmStart=Math.max(segStartOfDay,NOON_MINUTES);
      const pmEnd=Math.min(segEndOfDay,MINUTES_PER_DAY);
      if(pmEnd>pmStart) pm+=pmEnd-pmStart;

      rangeStart=segmentEnd;
    }

    return {am,pm};
  }

  function buildEntry(group){
    const id=String(group.BlockGroupId||'').trim();
    const blocks=Array.isArray(group.Blocks)?group.Blocks:[];
    const blockNumbers=[];
    const blockPeriods=Object.create(null);
    const seenNumbers=new Set();
    const matches=id.match(/\[(\d+)\]/g)||[];
    for(const raw of matches){
      const num=raw.replace(/[^0-9]/g,'');
      if(!num) continue;
      const parsed=parseInt(num,10);
      if(Number.isNaN(parsed)) continue;
      const normalized=String(parsed).padStart(2,'0');
      if(!seenNumbers.has(normalized)){
        seenNumbers.add(normalized);
        blockNumbers.push(normalized);
      }
    }

    const periodMatch=id.match(/\b(AM|PM)\b/i);
    const periodLabel=periodMatch?periodMatch[1].toLowerCase():'';

    if(periodLabel){
      for(const num of blockNumbers){
        blockPeriods[num]=periodLabel;
      }
    }else if(blockNumbers.length===2){
      blockPeriods[blockNumbers[0]]='am';
      blockPeriods[blockNumbers[1]]='pm';
    }

    let bus='—';
    for(const block of blocks){
      const trips=Array.isArray(block.Trips)?block.Trips:[];
      for(const trip of trips){
        const tripBus=trip?cleanBusIdentifier(trip.VehicleName):'';
        if(tripBus){
          bus=tripBus;
          break;
        }
      }
      if(bus!=='—') break;
    }

    let minStart=null;
    let maxEnd=null;
    let amMinutes=0;
    let pmMinutes=0;
    for(const block of blocks){
      const ranges=collectRanges(block);
      for(const range of ranges){
        let {start,end}=range;
        if(start==null && end==null) continue;
        if(start!=null && end!=null){
          const contribution=calculatePeriodMinutes(start,end);
          amMinutes+=contribution.am;
          pmMinutes+=contribution.pm;
        }
        if(start!=null){
          if(minStart==null || start<minStart) minStart=start;
        }
        if(start!=null && end!=null && end<start){
          end+=1440;
        }
        if(end!=null){
          if(minStart!=null && end<minStart){
            while(end<minStart){
              end+=1440;
            }
          }
          if(maxEnd==null || end>maxEnd) maxEnd=end;
        }
      }
    }

    let inferredPeriod='';
    if(periodLabel){
      inferredPeriod=periodLabel;
    }else if(amMinutes && !pmMinutes){
      inferredPeriod='am';
    }else if(pmMinutes && !amMinutes){
      inferredPeriod='pm';
    }else if(amMinutes || pmMinutes){
      if(pmMinutes>amMinutes) inferredPeriod='pm';
      else if(amMinutes>pmMinutes) inferredPeriod='am';
    }else if(minStart!=null && maxEnd!=null){
      let start=minStart;
      let end=maxEnd;
      if(end<start) end+=MINUTES_PER_DAY;
      const duration=end-start;
      if(duration>0){
        const midpoint=(start+duration/2)%MINUTES_PER_DAY;
        inferredPeriod=midpoint>=NOON_MINUTES?'pm':'am';
      }
    }

    const blockIdLookup=new Map();
    const blockNumberSet=new Set(blockNumbers);
    const hasAuthoritativeNumbers=blockNumbers.length>0;

    const addNumber=(num,{allowFromBlockId=false}={})=>{
      if(!num) return null;
      const parsed=parseInt(num,10);
      if(Number.isNaN(parsed)) return null;
      const normalized=String(parsed).padStart(2,'0');
      if(allowFromBlockId && hasAuthoritativeNumbers && !blockNumberSet.has(normalized)){
        return null;
      }
      if(!blockNumberSet.has(normalized)){
        blockNumberSet.add(normalized);
        blockNumbers.push(normalized);
      }
      return normalized;
    };

    for(const block of blocks){
      const blockInfoNumbers=[];
      const blockIdRaw=String(block.BlockId||'').trim();
      const normalizedId=normalizeIdentifier(blockIdRaw);
      if(normalizedId){
        const matchesNumbers=blockIdRaw.match(/\d+/g)||[];
        for(const rawNum of matchesNumbers){
          const normalizedNum=addNumber(rawNum,{allowFromBlockId:true});
          if(normalizedNum && !blockInfoNumbers.includes(normalizedNum)){
            blockInfoNumbers.push(normalizedNum);
          }
        }
      }

      let blockBus='—';
      const blockVehicleName=cleanBusIdentifier(block.VehicleName);
      if(blockVehicleName){
        blockBus=blockVehicleName;
      }
      if(blockBus==='—' && block.VehicleId!=null){
        const idString=cleanBusIdentifier(block.VehicleId);
        if(idString){
          blockBus=idString;
        }
      }
      const trips=Array.isArray(block.Trips)?block.Trips:[];
      for(const trip of trips){
        const tripBus=trip?cleanBusIdentifier(trip.VehicleName):'';
        if(tripBus){
          blockBus=tripBus;
          break;
        }
      }

      if(normalizedId){
        const periodsForBlock=Object.create(null);
        const periodInId=normalizedId.match(/(AM|PM)$/);
        if(periodInId){
          const label=periodInId[1].toLowerCase();
          for(const num of blockInfoNumbers){
            periodsForBlock[num]=label;
            if(!blockPeriods[num]){
              blockPeriods[num]=label;
            }
          }
        }
        blockIdLookup.set(normalizedId,{
          bus:blockBus,
          numbers:blockInfoNumbers.slice(),
          periods:periodsForBlock
        });
      }

      if(bus==='—' && blockBus && blockBus!=='—'){
        bus=blockBus;
      }
    }

    return {id,blockNumbers,blockPeriods,period:periodLabel,inferredPeriod,bus,minStart,maxEnd,blockIdLookup};
  }

  function isActive(entry,nowMinutes){
    if(entry.minStart==null || entry.maxEnd==null) return false;
    let start=entry.minStart;
    let end=entry.maxEnd;
    let now=nowMinutes;
    if(end<start){
      end+=1440;
      if(now<start) now+=1440;
    }
    return now>=start && now<=end;
  }

  function pickBest(entries,nowMinutes){
    if(!entries.length) return null;
    const active=entries.filter(e=>isActive(e,nowMinutes));
    const activeWithBus=active.find(e=>e.bus && e.bus!=='—');
    if(activeWithBus) return activeWithBus;
    if(active.length) return active[0];

    const withBus=entries.find(e=>e.bus && e.bus!=='—');
    if(withBus) return withBus;

    return entries[0];
  }

  function selectBestBus(matches,blockNumber,normalizedPeriod,nowMinutes){
    if(!matches.length) return '—';
    let filtered=matches;
    let allowFallback=!normalizedPeriod;
    if(blockNumber){
      const exactMatches=matches.filter(entry=>{
        const periods=entry.blockPeriods||null;
        if(!periods) return false;
        const assigned=periods[blockNumber];
        return assigned===normalizedPeriod;
      });
      if(normalizedPeriod && exactMatches.length){
        filtered=exactMatches;
        allowFallback=false;
      }else if(normalizedPeriod){
        const unspecified=matches.filter(entry=>{
          const periods=entry.blockPeriods||null;
          const assigned=periods?periods[blockNumber]:'';
          if(assigned) return false;
          const explicit=(entry.period||'').toLowerCase();
          if(explicit && explicit!==normalizedPeriod) return false;
          const inferred=(entry.inferredPeriod||'').toLowerCase();
          if(inferred && inferred!==normalizedPeriod) return false;
          return true;
        });
        if(unspecified.length){
          filtered=unspecified;
          allowFallback=true;
        }else if(!exactMatches.length){
          filtered=[];
          allowFallback=false;
        }
      }
    }else if(normalizedPeriod){
      const periodFiltered=matches.filter(entry=>{
        const explicit=(entry.period||'').toLowerCase();
        const inferred=(entry.inferredPeriod||'').toLowerCase();
        if(explicit) return explicit===normalizedPeriod;
        if(inferred) return inferred===normalizedPeriod;
        return true;
      });
      if(periodFiltered.length){
        filtered=periodFiltered;
        const hasPeriodInfo=periodFiltered.some(entry=>{
          const explicit=(entry.period||'').toLowerCase();
          const inferred=(entry.inferredPeriod||'').toLowerCase();
          return explicit || inferred;
        });
        allowFallback=!hasPeriodInfo;
      }else{
        filtered=[];
        allowFallback=false;
      }
    }

    const best=pickBest(filtered,nowMinutes);
    if(best && best.bus) return best.bus;
    if(filtered!==matches && allowFallback){
      const fallback=pickBest(matches,nowMinutes);
      if(fallback && fallback.bus) return fallback.bus;
    }
    return '—';
  }

  function findBestBus(blockNumber,periodSuffix,blockIdNormalized,entries,nowMinutes){
    const matches=blockNumber?entries.filter(e=>Array.isArray(e.blockNumbers)&&e.blockNumbers.includes(blockNumber)):[];
    const normalizedPeriod=(periodSuffix||'').toLowerCase();

    if(blockIdNormalized){
      const idCandidates=[];
      for(const entry of entries){
        const lookup=entry.blockIdLookup;
        if(lookup && lookup.has(blockIdNormalized)){
          const info=lookup.get(blockIdNormalized);
          const infoBusClean=cleanBusIdentifier(info.bus);
          const entryBusClean=cleanBusIdentifier(entry.bus);
          const candidate={
            bus:infoBusClean||entryBusClean||'—',
            blockNumbers:Array.isArray(info.numbers)&&info.numbers.length?info.numbers.slice():entry.blockNumbers.slice(),
            blockPeriods:(info.periods && Object.keys(info.periods).length)?info.periods:entry.blockPeriods,
            period:entry.period,
            inferredPeriod:entry.inferredPeriod,
            minStart:entry.minStart,
            maxEnd:entry.maxEnd
          };
          idCandidates.push(candidate);
        }
      }
      if(idCandidates.length){
        let targetNumber=blockNumber;
        if(!targetNumber){
          for(const candidate of idCandidates){
            if(Array.isArray(candidate.blockNumbers) && candidate.blockNumbers.length){
              targetNumber=candidate.blockNumbers[0];
              break;
            }
          }
        }
        const busFromId=selectBestBus(idCandidates,targetNumber||'',normalizedPeriod,nowMinutes);
        if(busFromId && busFromId!=='—') return busFromId;
        if(busFromId) return busFromId;
      }
    }
    if(!blockNumber){
      return '—';
    }
    if(!matches.length) return '—';
    return selectBestBus(matches,blockNumber,normalizedPeriod,nowMinutes);
  }

  function updateGrid(entries,nowMinutes){
    const cells=gridView.querySelectorAll('.cell[data-block], .cell[data-custom-block-id]');
    for(const cell of cells){
      const blockNumber=cell.dataset.block||'';
      const periodSuffix=cell.dataset.period||'';
      const customId=cell.dataset.customBlockId||'';
      const bus=findBestBus(blockNumber,periodSuffix,customId,entries,nowMinutes);
      const busEl=cell.querySelector('.bus');
      if(busEl){
        busEl.textContent=bus||'—';
      }
    }
  }

  async function refresh(){
    try{
      statusEl.textContent='';
      const res=await fetch('/v1/dispatch/blocks');
      if(!res.ok) throw new Error(res.status+'');
      const data=await res.json();
      const groups=Array.isArray(data.block_groups)?data.block_groups:[];
      const entries=[];
      for(const group of groups){
        const entry=buildEntry(group);
        const hasCustomIds=entry.blockIdLookup && entry.blockIdLookup.size;
        if(entry.blockNumbers.length || hasCustomIds){
          entries.push(entry);
        }
      }

      const now=new Date();
      const nowMinutes=now.getHours()*60+now.getMinutes();

      if(isGridMode){
        updateGrid(entries,nowMinutes);
      }else{
        const periodSuffix=blockPeriod||((periodParam==='am'||periodParam==='pm')?periodParam:'');
        const bus=findBestBus(selectedBlockNumber||'',periodSuffix,selectedBlockId,entries,nowMinutes);
        busEl.textContent=bus||'—';
        statusEl.textContent='';
      }
    }catch(err){
      console.error(err);
      statusEl.textContent='Offline';
      if(!isGridMode){
        busEl.textContent='--';
      }
    }
  }

  if(editMode && isGridMode){
    gridView.addEventListener('click',event=>{
      const addButton=event.target.closest('#add-column');
      if(addButton){
        event.preventDefault();
        event.stopPropagation();
        layout.push(createBlankColumn());
        saveLayout();
        buildGrid();
        refresh();
        return;
      }
      const removeButton=event.target.closest('#remove-column');
      if(removeButton){
        event.preventDefault();
        event.stopPropagation();
        if(layout.length<=1){
          alert('At least one column is required.');
          return;
        }
        const input=prompt(`Enter column number to remove (1-${layout.length}):`,String(layout.length));
        if(input===null) return;
        const index=parseInt(input,10)-1;
        if(!Number.isInteger(index) || index<0 || index>=layout.length){
          alert('Invalid column number.');
          return;
        }
        if(!confirm('Remove the selected column?')) return;
        layout.splice(index,1);
        saveLayout();
        buildGrid();
        refresh();
        return;
      }
      const resetButton=event.target.closest('#reset-layout');
      if(resetButton){
        event.preventDefault();
        event.stopPropagation();
        if(confirm('Reset layout to defaults?')){
          resetLayout();
          refresh();
        }
        return;
      }
      const cell=event.target.closest('.cell');
      if(!cell) return;
      const col=parseInt(cell.dataset.col||'-1',10);
      const row=parseInt(cell.dataset.row||'-1',10);
      if(!Number.isInteger(col) || !Number.isInteger(row) || col<0 || row<0) return;
      if(!layout[col]) layout[col]=[];
      const current=layout[col][row]||'';
      const input=prompt('Enter block label (e.g. "01", "20AM", or plain text; leave blank to clear):',current);
      if(input===null) return;
      const rawValue=String(input);
      const trimmed=rawValue.trim();
      if(!trimmed){
        layout[col][row]='';
      }else{
        const normalized=normalizeIdentifier(trimmed);
        if(/^(\d{2})(AM|PM)?$/.test(normalized)){
          layout[col][row]=normalized;
        }else{
          layout[col][row]=trimmed;
        }
      }
      saveLayout();
      buildGrid();
      refresh();
    });
  }else if(isGridMode){
    const controls=gridView.querySelector('.grid-controls');
    if(controls) controls.remove();
  }

  refresh();
  setInterval(refresh, 30000);
})();
</script>
